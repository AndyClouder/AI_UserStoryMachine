# StoryMachine 工具白皮书

## 摘要

StoryMachine 是一个基于人工智能的命令行工具，专为从产品需求文档（PRD）和技术规格自动生成上下文丰富的用户故事而设计。该工具支持多种AI提供商（OpenAI和智谱AI），提供完整的中文本地化支持，并通过与GitHub/GitLab集成实现代码库上下文感知，为敏捷开发团队提供高效的用户故事生成解决方案。

---

## 1. 工具概述

### 1.1 产品定位

StoryMachine 定位为AI驱动的产品需求管理工具，旨在解决传统用户故事编写过程中的痛点：

- **效率低下**：手动编写用户故事耗时耗力
- **标准不一**：不同团队成员编写的故事质量参差不齐
- **上下文缺失**：缺乏对技术实现和代码库的深入理解
- **语言障碍**：现有工具对中文支持不完善

### 1.2 核心价值主张

- 🤖 **智能生成**：基于先进的AI模型自动生成高质量用户故事
- 🇨🇳 **中文优化**：完整的中文语言支持和本地化提示词
- 🔄 **迭代优化**：人机协作的迭代式故事完善流程
- 🌐 **上下文感知**：集成代码库分析，提供技术实现背景
- 📋 **标准输出**：结构化的用户故事格式和验收标准

---

## 2. 技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    StoryMachine 系统架构                      │
├─────────────────────────────────────────────────────────────┤
│  CLI层 (cli.py)                                             │
│  ├─ 参数解析与验证                                           │
│  ├─ 文件读取与编码处理                                        │
│  └─ 配置显示与错误处理                                        │
├─────────────────────────────────────────────────────────────┤
│  工作流引擎 (workflow.py)                                    │
│  ├─ 流程编排与状态管理                                        │
│  ├─ 交互式反馈循环                                            │
│  └─ 故事生成流水线                                            │
├─────────────────────────────────────────────────────────────┤
│  活动层 (activities.py)                                      │
│  ├─ 代码库上下文分析                                          │
│  ├─ 故事生成与解析                                            │
│  ├─ 验收标准定义                                              │
│  └─ 上下文丰富化                                              │
├─────────────────────────────────────────────────────────────┤
│  AI抽象层 (ai.py, ai_zhipuai.py)                            │
│  ├─ 多提供商支持 (OpenAI/智谱AI)                             │
│  ├─ 工具调用与响应解析                                        │
│  ├─ 推理摘要提取                                              │
│  └─ 提示词模板管理                                            │
├─────────────────────────────────────────────────────────────┤
│  配置管理层 (config.py)                                      │
│  ├─ 环境变量配置                                              │
│  ├─ API密钥管理                                              │
│  └─ 模型参数配置                                              │
├─────────────────────────────────────────────────────────────┤
│  数据模型层 (types.py)                                       │
│  ├─ 故事数据结构                                              │
│  ├─ 工作流输入/输出类型                                       │
│  └─ 反馈响应类型                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件详解

#### 2.2.1 CLI层 (`cli.py`)
- **功能**：命令行界面入口点
- **特性**：
  - UTF-8编码处理，确保中文显示正常
  - 参数验证和错误处理
  - 配置信息展示
  - 优雅的中断处理

#### 2.2.2 工作流引擎 (`workflow.py`)
- **功能**：主要业务流程编排
- **流程**：
  1. 代码库上下文获取（可选）
  2. 故事生成与反馈循环
  3. 验收标准定义
  4. 上下文丰富化
  5. 最终输出生成

#### 2.2.3 活动层 (`activities.py`)
- **核心活动**：
  - `get_codebase_context()`: GitHub/GitLab代码库分析
  - `problem_break_down()`: 故事分解生成
  - `define_acceptance_criteria()`: 验收标准定义
  - `enrich_context()`: 上下文丰富化

#### 2.2.4 AI抽象层 (`ai.py`, `ai_zhipuai.py`)
- **多提供商支持**：
  - OpenAI: GPT系列模型，支持推理参数
  - 智谱AI: GLM系列模型，中文优化
- **工具调用**：结构化故事生成
- **响应解析**：灵活处理不同AI响应格式

---

## 3. 功能特性

### 3.1 AI驱动的故事生成

#### 3.1.1 智能分析能力
- **需求理解**：深度分析PRD和技术规格
- **故事分解**：将复杂需求拆分为可执行的用户故事
- **优先级识别**：自动标注故事优先级（[S]小、[M]中、[L]大）
- **依赖关系**：识别故事间的逻辑依赖

#### 3.1.2 结构化输出格式
```json
{
  "stories": [
    {
      "title": "[M] 用户登录功能",
      "acceptance_criteria": [
        "当用户输入正确的用户名和密码时，应该成功登录",
        "当用户输入错误凭据时，应该显示错误提示",
        "当用户连续3次登录失败时，应该锁定账户"
      ],
      "enriched_context": "基于现有的用户管理系统，集成JWT认证机制"
    }
  ]
}
```

### 3.2 多AI提供商支持

#### 3.2.1 OpenAI集成
- **支持模型**：GPT-4、GPT-3.5系列
- **推理支持**：o1、o3系列模型的高级推理能力
- **特性**：
  - 推理摘要显示
  - 对话上下文管理
  - 工具调用支持

#### 3.2.2 智谱AI集成
- **支持模型**：GLM-4-Flash、GLM-4、GLM-4-Plus
- **中文优化**：
  - 专门的中文提示词模板
  - 中文友好的响应解析
  - 本地化的错误处理
- **特性**：
  - 快速响应（GLM-4-Flash）
  - 高质量理解（GLM-4系列）
  - 成本效益优化

### 3.3 代码库上下文感知

#### 3.3.1 集成能力
- **GitHub支持**：公共仓库和私有仓库（需token）
- **GitLab支持**：自建和云端GitLab实例
- **ask-github集成**：智能代码库问答系统

#### 3.3.2 分析内容
- **项目结构**：目录树和文件组织
- **技术栈识别**：编程语言、框架、依赖
- **实现模式**：现有代码风格和架构模式
- **集成点**：新功能与现有代码的集成建议

### 3.4 交互式工作流程

#### 3.4.1 人机协作模式
```
生成 → 审核 → 反馈 → 修订 → 确认
```

#### 3.4.2 反馈机制
- **多语言支持**：支持中英文反馈
- **灵活输入**：支持多种确认/拒绝表达方式
- **具体建议**：可提供详细的修改建议
- **迭代优化**：多轮对话直到满意

---

## 4. 使用指南

### 4.1 环境配置

#### 4.1.1 安装依赖
```bash
# 使用uv包管理器
uv sync

# 或使用pip
pip install -e .
```

#### 4.1.2 环境变量配置
```bash
# 复制配置模板
cp .env.example .env

# 编辑配置文件
# AI提供商选择
API_PROVIDER=zhipuai  # 或 "openai"

# API密钥配置
ZHIPUAI_API_KEY=your_zhipuai_key
OPENAI_API_KEY=your_openai_key
GITHUB_TOKEN=your_github_token  # 可选
GITLAB_TOKEN=your_gitlab_token  # 可选

# 模型配置
MODEL=glm-4-flash  # 智谱AI: glm-4-flash, glm-4, glm-4-plus
                  # OpenAI: gpt-4, gpt-3.5-turbo等
REASONING_EFFORT=low  # OpenAI推理模型专用
```

### 4.2 基本使用

#### 4.2.1 最简用法
```bash
# 仅使用PRD文档
uv run storymachine --prd prd/product_requirements.md
```

#### 4.2.2 完整用法
```bash
# 使用PRD、技术规格和代码仓库
uv run storymachine \
  --prd prd/product_requirements.md \
  --tech-spec tech/technical_specification.md \
  --repo https://github.com/owner/repository
```

#### 4.2.3 输出示例
```
模型：glm-4-flash
推理强度：low

使用技术规格文件：tech/technical_specification.md
使用代码仓库：https://github.com/owner/repository

--- Getting Codebase Context ---

# Analyzing codebase needs...
✓ 代码库上下文获取完成

Generated Stories:
1. [M] 用户注册和登录功能
2. [S] 密码重置功能
3. [L] 个人资料管理模块
4. [S] 邮箱验证功能

Approve (y/n): y
Stories approved!

--- Detailing Story 1 ---
# Defining Acceptance Criteria...
✓ 验收标准定义完成

# Detailing the story...
✓ 故事丰富化完成

Story: [M] 用户注册和登录功能
Acceptance Criteria:
  1. 当新用户填写注册表单并提交时，应该创建账户并发送验证邮件
  2. 当用户输入正确的凭据时，应该成功登录并跳转到首页
  3. 当用户输入错误密码时，应该显示"用户名或密码错误"提示
  4. 当用户连续3次登录失败时，应该临时锁定账户15分钟

Context:
基于现有的用户管理系统，集成JWT认证机制，使用bcrypt密码加密...

Approve (y/n): y
Story approved!
```

### 4.3 高级功能

#### 4.3.1 自定义提示词模板
位于 `src/storymachine/prompts/` 目录：
- `problem_breakdown_zh_fixed.md`: 故事生成模板
- `acceptance_criteria_zh.md`: 验收标准模板
- `enrich_context_zh.md`: 上下文丰富化模板
- `iterating_on_stories_zh.md`: 迭代优化模板
- `repo_questions_zh.md`: 代码库分析模板

#### 4.3.2 调试和日志
- **结构化日志**：`storymachine.log`（JSON格式）
- **调试响应**：`debug_response.txt`（原始AI响应）
- **详细错误信息**：包含完整堆栈跟踪

---

## 5. 技术优势

### 5.1 架构优势

#### 5.1.1 模块化设计
- **松耦合**：各组件独立，易于维护和扩展
- **可测试**：每个模块都有对应的测试覆盖
- **可扩展**：新增AI提供商或功能模块简便

#### 5.1.2 异步处理
- **并发执行**：支持多个操作并行进行
- **性能优化**：减少等待时间，提升用户体验
- **资源高效**：合理利用系统资源

### 5.2 AI集成优势

#### 5.2.1 多提供商支持
- **避免依赖锁定**：不绑定单一AI提供商
- **成本优化**：可根据需求选择最优模型
- **功能互补**：不同模型有不同优势特点

#### 5.2.2 智能解析
- **多格式支持**：JSON、XML、纯文本响应
- **错误恢复**：解析失败时的降级处理
- **调试友好**：详细的解析过程日志

### 5.3 本地化优势

#### 5.3.1 中文优化
- **提示词优化**：专门针对中文语境设计
- **编码处理**：完善的UTF-8编码支持
- **界面本地化**：中文用户界面和错误信息

#### 5.3.2 文化适配
- **表达习惯**：符合中文用户表达习惯
- **业务术语**：使用中文产品管理通用术语
- **协作方式**：适配中文团队协作模式

---

## 6. 应用场景

### 6.1 适用团队

#### 6.1.1 敏捷开发团队
- **Scrum团队**：快速生成Sprint Backlog
- **Kanban团队**：持续的用户故事流
- **产品团队**：快速原型和需求验证

#### 6.1.2 不同规模组织
- **初创公司**：资源有限，需要高效工具
- **中型企业**：标准化需求管理流程
- **大型企业**：统一的质量标准和最佳实践

### 6.2 应用阶段

#### 6.2.1 产品规划阶段
- **需求梳理**：将产品需求转化为可执行故事
- **工作量评估**：初步的故事点评估
- **优先级排序**：基于业务价值和技术复杂度

#### 6.2.2 开发准备阶段
- **技术分析**：结合代码库现状制定实现方案
- **依赖识别**：识别技术依赖和团队协作需求
- **风险评估**：潜在的技术风险和实现难点

### 6.3 典型用例

#### 6.3.1 新产品开发
```
PRD文档 → StoryMachine → 完整用户故事集 → 开发执行
```

#### 6.3.2 功能迭代
```
功能需求 → 技术规格 → StoryMachine → 增量用户故事 → 迭代开发
```

#### 6.3.3 遗留系统改造
```
现状分析 → 改造需求 → StoryMachine + 代码库分析 → 渐进式改造计划
```

---

## 7. 最佳实践

### 7.1 PRD编写指南

#### 7.1.1 结构化内容
```markdown
# 产品需求文档

## 1. 项目概述
- 项目背景
- 业务目标
- 用户群体

## 2. 功能需求
### 2.1 核心功能
- 功能描述
- 用户场景
- 业务规则

### 2.2 非功能需求
- 性能要求
- 安全要求
- 可用性要求

## 3. 技术约束
- 技术栈要求
- 集成要求
- 兼容性要求
```

#### 7.1.2 写作要点
- **具体明确**：避免模糊和歧义的表达
- **用户导向**：从用户视角描述需求
- **可测试性**：需求应该是可验证和可测试的
- **完整性**：涵盖各种使用场景和边缘情况

### 7.2 技术规格编写

#### 7.2.1 技术架构
- **系统架构图**：整体架构和组件关系
- **技术栈选择**：编程语言、框架、数据库等
- **接口设计**：API设计规范和数据格式

#### 7.2.2 实现细节
- **核心算法**：关键业务逻辑的算法描述
- **性能考虑**：性能优化策略和监控指标
- **安全方案**：数据加密、访问控制、审计日志

### 7.3 代码库集成

#### 7.3.1 项目结构
- **清晰的目录结构**：便于理解和维护
- **命名规范**：统一的命名约定
- **文档完整**：README、API文档、架构文档

#### 7.3.2 代码质量
- **代码规范**：一致的编码风格
- **单元测试**：充分的测试覆盖
- **代码审查**：质量保证流程

---

## 8. 性能与安全

### 8.1 性能特性

#### 8.1.1 响应时间
- **快速生成**：单个故事生成通常在10-30秒内
- **并发处理**：支持多个故事并行处理
- **缓存机制**：代码库分析结果缓存，减少重复请求

#### 8.1.2 资源使用
- **内存占用**：优化的内存使用，避免内存泄漏
- **网络效率**：合理的API调用频率和重试机制
- **存储需求**：最小化的本地存储需求

### 8.2 安全保障

#### 8.2.1 API密钥保护
- **环境变量**：敏感信息通过环境变量管理
- **本地存储**：API密钥不记录在日志中
- **访问控制**：支持私有仓库的token认证

#### 8.2.2 数据隐私
- **本地处理**：敏感文档在本地处理
- **数据清理**：调试信息中的敏感数据脱敏
- **传输安全**：HTTPS加密传输

---

## 9. 发展规划

### 9.1 短期计划（3个月）

#### 9.1.1 功能增强
- **更多AI模型**：支持更多国内外AI模型
- **故事评估**：自动故事复杂度和工作量评估
- **模板库**：预设行业模板和最佳实践

#### 9.1.2 用户体验
- **Web界面**：提供图形化操作界面
- **团队协作**：支持多人协作和评论
- **历史记录**：保存和管理历史生成记录

### 9.2 中期计划（6-12个月）

#### 9.2.1 集成能力
- **项目管理工具**：集成Jira、Trello、飞书等
- **CI/CD集成**：与持续集成流程集成
- **代码生成**：基于故事自动生成代码框架

#### 9.2.2 智能化提升
- **学习能力**：从用户反馈中学习优化
- **推荐系统**：智能推荐相关故事和最佳实践
- **质量评估**：自动评估故事质量和完善度

### 9.3 长期愿景（1-2年）

#### 9.3.1 平台化发展
- **开放平台**：提供API和插件机制
- **生态系统**：构建第三方开发者生态
- **企业版本**：提供企业级功能和支持

#### 9.3.2 技术演进
- **多模态支持**：支持图片、视频等多媒体需求
- **实时协作**：实时多人协作编辑
- **AI原生**：深度集成AI能力，提供智能决策支持

---

## 10. 总结

StoryMachine 作为新一代的AI驱动用户故事生成工具，通过深度集成先进的人工智能技术和软件工程最佳实践，为敏捷开发团队提供了高效、智能、易用的用户故事生成解决方案。

### 10.1 核心优势

- **技术先进**：基于最新的AI模型，支持多提供商选择
- **中文优化**：完整的中文本地化支持，符合国内团队使用习惯
- **易于集成**：简单配置即可与现有开发流程集成
- **人机协作**：保持人工控制，确保输出质量
- **持续进化**：活跃的开发和定期的功能更新

### 10.2 价值创造

- **效率提升**：显著减少用户故事编写时间
- **质量保证**：标准化输出格式，提高故事质量一致性
- **成本优化**：减少人工成本，加速产品交付
- **风险降低**：通过上下文感知减少技术实现风险

### 10.3 行业影响

StoryMachine 不仅是一个工具，更是软件工程领域AI应用的典型范例。它展示了如何将人工智能技术与传统的软件开发流程深度结合，创造出真正为开发团队赋能的工具。随着技术的不断发展和完善，StoryMachine 将继续引领AI在软件工程领域的应用创新，为推动整个行业的数字化转型贡献力量。

---

*本文档最后更新时间：2025年11月*

*更多信息请访问：https://github.com/nilenso/storymachine*